# RocketMQ 核心概念

`nameServer` 注册中心。提供消息的转换和路由，可以有多个，但数据可以不一致

`broker` 最终存储消息的地方，同nameServer保持心跳连接，可以不用同Nameserver部署在同一台服务器

Topic ，消息归类。中包含队列，四个读队列，四个写队列，可以调整，但无法直接操作，由MQ来操作。内部的target代表一个小类

推是指服务器主动推送消息给客户端，但是需要保持长连接，且无法预知客户端状态

拉指客户端主动连接服务器端获取消息，频率过低会资源浪费，频率过高会堆积消息

推拉一体指的是客户端间隔一段时间发送一个长连接的Pull消息，如果在这段时间内收到消息，则保持连接，否则连续三次判断没有消息，默认5秒关闭连接，间隔一段时间后再次发送连接

默认消息是无序的，因为消息保存在不同的队列中；消费者默认会开启20个线程去平均的方式消费队列，线程数除以队列数，平均分配线程消费队列；消费者启动的时候，发送的消息在消费的时候也是无序的，展示有序是因为消费速度过快

消息有序的前提：1. 消息必须全部发送存储在同一个队列中；2. 每个队列都只能对应一个线程消费

生产者部分：第一步，生产者需要指定队列选择器 `SelectMessageQueue`

消费者部分：`MessageListenerConcurrently` ：多线程消费单队列

`MessageListenerOrderly` ：单线程消费单队列。间隔20秒锁定一次属于自己的队列，当队列被锁定后，就不会给其他消费者消费，当他本次拉取消息消费完成之后解锁

延迟消费，根据集群中的级别配置，配置的值为序号

延迟消费的消息在超过时间后会进入死信队列，该队列由配置创建，类似于垃圾站，进入死信队列的消息也可以消费

批量发送是可以发送集合，不支持延迟消费，不支持

当回复MQ的事务状态是UNKNOW时，事务会挂起，MQ会间隔一分钟重新请求生产者获取消息状态

当事务执行时间超长的时候，当一个依赖于别的事务的执行结果的时候，可以选择挂起

生产者组：当生产者组内有生产者无法提供事务回调的时候，就会由组内其他生产者提供事务回调

消费者组：同一消费者组内成员同时处理当前topic中所有消息



broker针对于多消费者的分配算法

- `AllocateMessageQueueAveragely` 分页算法，依照消费者数量进行分页，剩余部分归于最后一页
- `AllocateMachineRoomNearby` 就近(broker) 算法，同一局域网机房优先分配
- `AllocateMessageQueueAveragelyByCircle` 循环平均Hash队列算法 当消费者数量大于Broker数量时候，就有消费者挂机
- `AllocateMessageQueueByConfig`  指定队列
- `AllocateMessageQueueByMachineRoom` 指定broker
- `AllocateMessageQueueConsistentHash` 一致性Hash队列算法，环算法

在同一个消费者组的情况下，一个队列只能被一个消费者消费。



消费模式默认是集群模式，可选广播模式。广播模式下消息无法重试

消息长时间没消费成功，或返回消费状态为重发，或返回null，或抛出异常，均会导致重发

RocketMQ重发机制：由MQ来规定一段时间之后再把消息重新推送一遍

`MessageDelayLevel` 既是消息延迟级别也是消息重发时间间隔，如果级别不够16个，则之后的几次均取最后一个级别的时间。

重发是一个专门的队列，重发16次还是失败，则进入死信队列

只有当Topic产生过死信消息时，才会生成对应的死信队列，否则没有死信队列

在控制台查看死信队列时，`perm` 参数标志为读写状态，默认为2，取值为2、4、6，如果为2，则不允许主动读取，为4的话不能写入消息，为6可读也可写

消费者可以设置Consumer的`setMaxReconsumeTimes` 修改重试次数，该修改属于覆盖操作，后覆盖前



MQ集群有四个元素：nameServer集群、Producer集群、Consumer集群、Broker集群。其中nameServer集群各个节点之间数据不同步

broker集群允许有多个主节点，主节点需要设置id为0，存在组集群的概念，broker name一样就是一个组集群，一个组集群内不允许ID重复，也就只能存在一个主节点。主节点挂掉，Slave从节点不会升级为主节点。MQ建议broker集群为两主两从，对于多主情况，如果单台Master节点宕机，那么这个Master上的消息不会被消费，直到主节点重新启动成功。producer只会连接master节点，而consumer会既连主节点，也连从节点。

从节点只能读，主节点可以读写。

当所有的主节点宕机，则生产者无法工作，但只要有slave节点存活，消费者依然可以消费消息。**死信消息的名称是根据组名称生成的，不是根据topic生成的。**

同步是指刷磁盘和数据同步至从节点执行完毕之后，返回消息，保证消息同步

异步消息是指主节点写入成功之后就返回执行结果，刷磁盘和数据同步异步进行

可以选择同步复制消息，异步刷盘

